<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Đối Soát V8 Pro | AI Powered</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        brand: {
                            50: '#f0fdfa', 100: '#ccfbf1', 200: '#99f6e4', 300: '#5eead4',
                            400: '#2dd4bf', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e',
                            800: '#115e59', 900: '#134e4a', 950: '#042f2e',
                        },
                        glass: {
                            100: 'rgba(255, 255, 255, 0.1)',
                            200: 'rgba(255, 255, 255, 0.2)',
                            300: 'rgba(255, 255, 255, 0.3)',
                            border: 'rgba(255, 255, 255, 0.2)'
                        }
                    },
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'float': 'float 3s ease-in-out infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: #0f172a;
            background-image:
                radial-gradient(at 0% 0%, hsla(253, 16%, 7%, 1) 0, transparent 50%),
                radial-gradient(at 50% 0%, hsla(225, 39%, 30%, 1) 0, transparent 50%),
                radial-gradient(at 100% 0%, hsla(339, 49%, 30%, 1) 0, transparent 50%);
            color: #e2e8f0;
        }

        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-input {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.3s ease;
        }

        .glass-input:focus {
            background: rgba(15, 23, 42, 0.9);
            border-color: #2dd4bf;
            outline: none;
            box-shadow: 0 0 0 2px rgba(45, 212, 191, 0.2);
        }

        .scroller::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .scroller::-webkit-scrollbar-track {
            background: transparent;
        }

        .scroller::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 10px;
        }

        .scroller::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.5);
        }

        .scan-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 2px;
            background: #2dd4bf;
            box-shadow: 0 0 15px #2dd4bf;
            animation: scan 2s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes scan {
            0% {
                top: 0%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col overflow-hidden selection:bg-brand-500 selection:text-white">

    <div id="app" class="flex flex-col h-full">

        <!-- Header -->
        <header class="h-16 glass-panel z-50 flex justify-between items-center px-6 relative">

            <div class="flex items-center gap-4">
                <div
                    class="w-10 h-10 rounded-xl bg-gradient-to-tr from-brand-600 to-indigo-600 flex items-center justify-center shadow-lg shadow-brand-500/20">
                    <i class="fa-solid fa-layer-group text-white text-lg"></i>
                </div>
                <div>
                    <h1
                        class="font-bold text-xl tracking-wide bg-gradient-to-r from-white to-brand-200 bg-clip-text text-transparent">
                        V8 VERIFY PRO</h1>
                    <div class="flex items-center gap-2">
                        <span class="text-[10px] uppercase tracking-widest text-slate-400 font-semibold">Model:</span>
                        <select v-model="selectedModel"
                            class="bg-slate-800 text-[10px] text-brand-300 border border-slate-700 rounded px-1 py-0.5 outline-none focus:border-brand-500 hover:bg-slate-700 cursor-pointer">
                            <option v-for="m in availableModels" :key="m.id" :value="m.id">{{ m.name }}</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="relative group">
                    <div
                        class="flex items-center gap-2 bg-slate-800/50 border border-slate-700/50 rounded-full pl-3 pr-1 py-1 transition-all focus-within:border-brand-500/50 focus-within:bg-slate-800">
                        <i class="fa-brands fa-google text-slate-400"></i>
                        <input v-model="apiKey" :type="showKey ? 'text' : 'password'"
                            placeholder="Nhập Gemini API Key..."
                            class="bg-transparent border-none text-xs text-brand-100 placeholder-slate-500 focus:outline-none w-64 px-2 py-1">
                        <button @click="showKey = !showKey"
                            class="w-7 h-7 rounded-full bg-slate-700 hover:bg-slate-600 text-slate-300 text-xs flex items-center justify-center transition">
                            <i :class="showKey ? 'fa-solid fa-eye-slash' : 'fa-solid fa-eye'"></i>
                        </button>
                        <button @click="testConnection"
                            class="w-7 h-7 rounded-full bg-slate-700 hover:bg-green-600 hover:text-white text-slate-300 text-xs flex items-center justify-center transition ml-1"
                            title="Test Kết Nối">
                            <i class="fa-solid fa-plug"></i>
                        </button>
                    </div>
                </div>

                <a href="#"
                    class="w-9 h-9 rounded-full bg-slate-800 border border-slate-700 hover:bg-slate-700 hover:border-slate-600 flex items-center justify-center transition text-slate-400">
                    <i class="fa-solid fa-gear"></i>
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 flex overflow-hidden relative">

            <!-- Left Panel: Image Viewer (Vertical Optimized) -->
            <div
                class="w-full lg:w-4/12 relative bg-slate-900 border-r border-slate-800 flex flex-col group/viewer z-10">

                <!-- Toolbar -->
                <div
                    class="absolute top-4 left-1/2 -translate-x-1/2 z-20 flex gap-2 opacity-0 group-hover/viewer:opacity-100 transition-all duration-300 scale-95 group-hover/viewer:scale-100">
                    <button @click="zoomIn"
                        class="w-8 h-8 rounded-lg bg-black/50 hover:bg-black/70 backdrop-blur text-white border border-white/10 flex items-center justify-center font-bold shadow-lg"><i
                            class="fa-solid fa-plus"></i></button>
                    <button @click="resetZoom"
                        class="px-3 h-8 rounded-lg bg-black/50 hover:bg-black/70 backdrop-blur text-white border border-white/10 text-xs font-bold shadow-lg">{{
                        zoomLevel }}%</button>
                    <button @click="zoomOut"
                        class="w-8 h-8 rounded-lg bg-black/50 hover:bg-black/70 backdrop-blur text-white border border-white/10 flex items-center justify-center font-bold shadow-lg"><i
                            class="fa-solid fa-minus"></i></button>
                </div>

                <!-- Viewer Area -->
                <div class="flex-1 overflow-hidden relative flex items-center justify-center bg-slate-950"
                    @dragover.prevent="dragOver = true" @dragleave.prevent="dragOver = false"
                    @drop.prevent="handleDrop">
                    <!-- Placeholder -->
                    <div v-if="!imageSrc" class="text-center p-8 transition-all duration-300 group cursor-pointer"
                        :class="dragOver ? 'scale-105' : ''" @click="$refs.fileInput.click()">
                        <div
                            class="w-20 h-20 rounded-2xl bg-slate-800/50 border border-slate-700 mx-auto flex items-center justify-center mb-6 group-hover:border-brand-500 group-hover:bg-brand-500/10 transition-all shadow-2xl">
                            <i class="fa-solid fa-image text-3xl"
                                :class="dragOver ? 'text-brand-400' : 'text-slate-500 group-hover:text-brand-400'"></i>
                        </div>
                        <h3 class="text-lg font-bold text-slate-300 mb-2">Tải ảnh biên lai</h3>
                        <p class="text-sm text-slate-500 max-w-[200px] mx-auto">Kéo thả hoặc click để chọn ảnh (Hỗ trợ
                            tốt ảnh dọc từ điện thoại)</p>
                        <input type="file" ref="fileInput" @change="handleFileUpload" accept="image/*" class="hidden">
                    </div>

                    <!-- Image with Pan/Zoom -->
                    <div v-else
                        class="w-full h-full overflow-auto scroller cursor-grab active:cursor-grabbing flex items-center justify-center relative bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAiIGhlaWdodD0iMjAiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEgMWgydjJIMUMxem00IDBoMnYySDV6bTQgMGgydjJIOXptNCAwaDJ2MmgxM3oiIGZpbGw9IiMxZTI5M2IiIGZpbGwtb3BhY2l0eT0iMC4xIi8+PC9zdmc+')]">
                        <div class="relative transition-transform duration-200 ease-out origin-center shadow-2xl"
                            :style="{ transform: `scale(${zoomLevel/100}) rotate(${rotation}deg)` }">
                            <!-- Scan Effect -->
                            <div v-if="isProcessing" class="scan-line top-0 z-10 w-full rounded-lg"></div>
                            <img :src="imageSrc"
                                class="max-w-none rounded-lg border border-slate-700 select-none shadow-2xl shadow-black"
                                alt="Receipt">
                        </div>
                    </div>
                </div>

                <!-- Footer Actions -->
                <div v-if="imageSrc"
                    class="h-14 bg-slate-900 border-t border-slate-800 flex items-center justify-between px-4 z-20">
                    <button @click="resetApp"
                        class="text-red-400 hover:text-red-300 hover:bg-red-500/10 px-3 py-1.5 rounded-lg text-xs font-semibold transition flex items-center gap-2">
                        <i class="fa-solid fa-trash"></i> Xoá ảnh
                    </button>
                    <div class="flex gap-2">
                        <button @click="rotation -= 90"
                            class="w-8 h-8 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition"><i
                                class="fa-solid fa-rotate-left"></i></button>
                        <button @click="rotation += 90"
                            class="w-8 h-8 rounded bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition"><i
                                class="fa-solid fa-rotate-right"></i></button>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Data Form -->
            <div class="w-full lg:w-8/12 relative flex flex-col bg-slate-50/5 relative z-0">

                <!-- Background Decoration -->
                <div class="absolute inset-0 z-[-1] overflow-hidden pointer-events-none">
                    <div
                        class="absolute top-[-10%] right-[-10%] w-[500px] h-[500px] bg-brand-500/5 rounded-full blur-3xl">
                    </div>
                    <div
                        class="absolute bottom-[-10%] left-[-10%] w-[500px] h-[500px] bg-indigo-500/5 rounded-full blur-3xl">
                    </div>
                </div>

                <!-- Processing Overlay -->
                <div v-if="isProcessing"
                    class="absolute inset-0 z-50 bg-slate-900/80 backdrop-blur-sm flex flex-col items-center justify-center">
                    <div class="relative w-24 h-24 mb-8">
                        <div class="absolute inset-0 rounded-full border-4 border-slate-700"></div>
                        <div class="absolute inset-0 rounded-full border-4 border-t-brand-400 animate-spin"></div>
                        <i
                            class="fa-solid fa-file-invoice-dollar absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-3xl text-brand-400 animate-pulse"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">Đang phân tích...</h3>
                    <p class="text-slate-400 font-medium animate-pulse">AI đang đọc dữ liệu từ biên lai</p>
                </div>

                <!-- Results Form -->
                <div class="flex-1 overflow-y-auto scroller p-4 lg:p-8 pb-32">

                    <!-- Section 1: Thông tin chung -->
                    <div class="glass-panel rounded-2xl p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h3
                                class="flex items-center gap-2 text-brand-300 font-bold uppercase text-sm tracking-wider">
                                <i class="fa-solid fa-circle-info"></i> Thông Tin Giao Dịch
                            </h3>
                            <div v-if="form.sender_name"
                                class="flex items-center gap-2 px-3 py-1 rounded-full bg-brand-500/20 border border-brand-500/30 text-brand-300 text-[10px] font-bold uppercase animate-pulse-fast">
                                <i class="fa-solid fa-check-circle"></i> Đã nhận diện
                            </div>
                        </div>

                        <div class="grid grid-cols-12 gap-4">
                            <!-- Sender -->
                            <div class="col-span-12 lg:col-span-8">
                                <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Người
                                    gửi</label>
                                <input v-model="form.sender_name" type="text"
                                    class="glass-input w-full rounded-xl px-4 py-3 text-sm font-bold text-white placeholder-slate-600"
                                    placeholder="Chưa xác định...">
                            </div>
                            <!-- Date -->
                            <div class="col-span-12 lg:col-span-4">
                                <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Thời
                                    gian</label>
                                <input v-model="form.transaction_date" type="datetime-local"
                                    class="glass-input w-full rounded-xl px-4 py-3 text-sm text-slate-300">
                            </div>

                            <!-- Total Amount (Big) -->
                            <div class="col-span-12 mt-2">
                                <label class="block text-[10px] uppercase font-bold text-slate-400 mb-1.5 ml-1">Tổng
                                    tiền chuyển khoản (Gốc)</label>
                                <div class="relative group">
                                    <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                                        <span class="text-slate-500 font-bold">$</span>
                                    </div>
                                    <input type="text" :value="formatCurrency(form.total_amount)"
                                        @input="updateTotalAmount"
                                        class="glass-input w-full rounded-xl pl-10 pr-16 py-4 text-2xl font-black text-brand-300 tracking-tight text-right placeholder-slate-700 focus:text-brand-200"
                                        placeholder="0">
                                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none">
                                        <span
                                            class="text-brand-500 font-bold text-sm bg-brand-500/10 px-2 py-0.5 rounded">VNĐ</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Receiver Info (Small) -->
                            <div
                                class="col-span-12 grid grid-cols-3 gap-3 mt-2 opacity-60 hover:opacity-100 transition-opacity">
                                <input v-model="form.receiver_name" class="glass-input rounded-lg px-3 py-2 text-xs"
                                    placeholder="Tên người nhận">
                                <input v-model="form.receiver_bank" class="glass-input rounded-lg px-3 py-2 text-xs"
                                    placeholder="Ngân hàng">
                                <input v-model="form.receiver_account" class="glass-input rounded-lg px-3 py-2 text-xs"
                                    placeholder="Số tài khoản">
                            </div>
                        </div>
                    </div>

                    <!-- Section 2: Chi tiết cược -->
                    <div class="glass-panel rounded-2xl overflow-hidden flex flex-col min-h-[400px]">
                        <div
                            class="bg-slate-800/50 border-b border-white/5 px-6 py-4 flex justify-between items-center">
                            <h3
                                class="flex items-center gap-2 text-indigo-300 font-bold uppercase text-sm tracking-wider">
                                <i class="fa-solid fa-list-ol"></i> Chi Tiết Cược
                            </h3>
                            <div class="flex gap-2">
                                <span
                                    class="bg-indigo-500/20 text-indigo-300 px-3 py-1 rounded-lg text-xs font-bold border border-indigo-500/30">
                                    {{ form.bets.length }} dòng
                                </span>
                                <span
                                    class="bg-brand-500/20 text-brand-300 px-3 py-1 rounded-lg text-xs font-bold border border-brand-500/30">
                                    {{ formatCurrency(sumBets) }} đ
                                </span>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="flex-1 overflow-x-auto">
                            <table class="w-full text-left border-collapse">
                                <thead>
                                    <tr
                                        class="text-[10px] uppercase text-slate-500 font-bold border-b border-white/5 bg-slate-900/30">
                                        <th class="p-4 w-16 text-center">Mã</th>
                                        <th class="p-4">Con Vật</th>
                                        <th class="p-4 text-right">Tiền Cược (k)</th>
                                        <th class="p-4 text-right">Thành Tiền</th>
                                        <th class="p-4 w-10"></th>
                                    </tr>
                                </thead>
                                <tbody class="text-sm divide-y divide-white/5">
                                    <tr v-if="form.bets.length === 0">
                                        <td colspan="5" class="p-8 text-center text-slate-500 italic">
                                            Chưa có dữ liệu. Vui lòng tải ảnh biên lai.
                                        </td>
                                    </tr>
                                    <tr v-for="(bet, index) in form.bets" :key="index"
                                        class="group hover:bg-white/5 transition-colors">
                                        <td class="p-3 text-center">
                                            <span
                                                class="inline-block w-8 h-8 leading-8 rounded bg-slate-800 font-mono font-bold text-brand-400 border border-slate-700 shadow-inner">
                                                {{ bet.code }}
                                            </span>
                                        </td>
                                        <td class="p-3">
                                            <div class="font-bold text-slate-200 group-hover:text-white">{{
                                                bet.common_name }}</div>
                                            <div class="text-[10px] text-slate-500 font-mono">{{ bet.matched_text }}
                                            </div>
                                        </td>
                                        <td class="p-3 text-right">
                                            <input type="number" v-model="bet.amount_k"
                                                class="glass-input w-24 text-right px-2 py-1.5 rounded text-brand-300 font-bold focus:bg-slate-800"
                                                min="0">
                                        </td>
                                        <td class="p-3 text-right font-mono text-slate-400">
                                            {{ formatCurrency(bet.amount_k * 1000) }}
                                        </td>
                                        <td class="p-3 text-center">
                                            <button @click="removeBet(index)"
                                                class="text-slate-600 hover:text-red-400 transition w-8 h-8 rounded-full hover:bg-red-500/10 flex items-center justify-center">
                                                <i class="fa-solid fa-xmark"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Manual Add -->
                        <div class="p-4 bg-slate-900/50 border-t border-white/5">
                            <div class="flex items-center gap-2 mb-3">
                                <i class="fa-solid fa-plus-circle text-brand-400 text-xs"></i>
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Thêm thủ
                                    công</span>
                            </div>
                            <div
                                class="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-9 lg:grid-cols-9 gap-1.5 h-32 overflow-y-auto scroller pr-1">
                                <button v-for="animal in animalDb" :key="animal.code" @click="addBet(animal)"
                                    class="relative group bg-slate-800 border border-slate-700 hover:border-brand-500 hover:bg-brand-900/20 rounded p-1.5 flex flex-col items-center transition-all overflow-hidden">
                                    <span class="text-[10px] font-bold text-slate-300 group-hover:text-brand-300">{{
                                        animal.code }}</span>
                                    <span
                                        class="text-[8px] text-slate-500 group-hover:text-brand-400 truncate w-full text-center mt-0.5">{{
                                        animal.common }}</span>
                                    <div
                                        class="absolute inset-0 bg-gradient-to-tr from-transparent via-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity">
                                    </div>
                                </button>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Footer Summary Bar (Fixed) -->
                <div
                    class="absolute bottom-0 left-0 right-0 bg-slate-900/90 backdrop-blur-xl border-t border-slate-700 p-4 z-40 flex items-center gap-4 lg:gap-6 shadow-2xl">

                    <!-- Balance Indicator -->
                    <div
                        class="flex-1 flex items-center justify-between bg-slate-800/50 rounded-xl px-4 py-2 border border-slate-700">
                        <div>
                            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Trạng thái</div>
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-full"
                                    :class="diff === 0 ? 'bg-green-500 shadow-[0_0_10px_#22c55e]' : 'bg-red-500 shadow-[0_0_10px_#ef4444] animate-pulse'">
                                </div>
                                <span class="font-bold text-sm hidden lg:inline"
                                    :class="diff === 0 ? 'text-green-400' : 'text-red-400'">
                                    {{ diff === 0 ? 'KHỚP LỆNH' : 'LỆCH TIỀN' }}
                                </span>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="text-[10px] font-bold text-slate-500 uppercase tracking-wider">Chênh lệch</div>
                            <div class="text-xl font-mono font-black"
                                :class="diff === 0 ? 'text-green-400' : 'text-red-500'">
                                {{ diff > 0 ? '+' : '' }}{{ formatCurrency(diff) }}
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <button @click="showSheetConfig = true"
                        class="h-12 w-12 lg:w-auto lg:h-14 lg:px-6 rounded-xl bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-300 hover:text-white transition flex items-center justify-center gap-2 group"
                        title="Kết nối Google Sheets">
                        <i class="fa-brands fa-google-drive text-green-400 text-lg"></i>
                        <span class="hidden lg:inline text-sm font-bold">Kết Nối</span>
                    </button>

                    <button @click="exportAction" :disabled="diff !== 0 && !allowExportAnyway"
                        class="h-14 px-6 lg:px-8 rounded-xl font-bold text-slate-900 shadow-lg shadow-brand-500/20 transition-all flex items-center gap-3 disabled:opacity-50 disabled:cursor-not-allowed group relative overflow-hidden"
                        :class="diff === 0 || allowExportAnyway ? 'bg-gradient-to-r from-brand-400 to-teal-400 hover:from-brand-300 hover:to-teal-300 scale-100' : 'bg-slate-700 text-slate-400'">
                        <div class="z-10 flex items-center gap-2">
                            <span>LƯU DỮ LIỆU</span>
                            <i class="fa-solid fa-cloud-arrow-up group-hover:-translate-y-1 transition-transform"></i>
                        </div>
                        <div v-if="diff === 0"
                            class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-700">
                        </div>
                    </button>

                    <div v-if="diff !== 0" class="absolute -top-12 right-4">
                        <label
                            class="flex items-center gap-2 bg-slate-800 text-xs text-slate-400 px-3 py-1.5 rounded border border-slate-700 cursor-pointer hover:text-white">
                            <input type="checkbox" v-model="allowExportAnyway"
                                class="rounded bg-slate-700 border-slate-600 text-brand-500 focus:ring-0">
                            <span>Cho phép lưu dù lệch tiền</span>
                        </label>
                    </div>

                </div>

            </div>
        </main>

        <!-- Sheets Config Modal -->
        <div v-if="showSheetConfig"
            class="fixed inset-0 z-[60] flex items-center justify-center bg-black/90 backdrop-blur-sm p-4 animate-in fade-in zoom-in duration-200">
            <div
                class="bg-slate-900 border border-slate-700 rounded-2xl w-full max-w-3xl shadow-2xl p-0 relative overflow-hidden">
                <!-- Header -->
                <div class="bg-slate-800/50 p-4 border-b border-white/5 flex justify-between items-center">
                    <h3 class="text-lg font-bold text-white flex items-center gap-2"><i
                            class="fa-brands fa-google-drive text-green-400"></i> Cấu Hình Google Sheets</h3>
                    <button @click="showSheetConfig = false" class="text-slate-400 hover:text-white"><i
                            class="fa-solid fa-xmark text-xl"></i></button>
                </div>

                <div class="p-6 space-y-6 max-h-[80vh] overflow-y-auto scroller">
                    <!-- Step 1 -->
                    <div class="relative pl-8 border-l-2 border-slate-700">
                        <div
                            class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 border-2 border-slate-900 text-[10px] flex items-center justify-center font-bold text-slate-300">
                            1</div>
                        <h4 class="text-sm font-bold text-brand-200 uppercase mb-2">Copy Mã Script</h4>
                        <div class="bg-slate-950 p-4 rounded-xl border border-slate-800 relative group">
                            <pre class="text-[11px] text-green-400 font-mono overflow-x-auto whitespace-pre custom-scrollbar"
                                id="scriptCode">
function doPost(e) {
  var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  var data = JSON.parse(e.postData.contents);
  var dateStr = Utilities.formatDate(new Date(), "GMT+7", "yyyy-MM-dd HH:mm:ss");
  
  // Create Header if empty
  if (sheet.getLastRow() === 0) {
    sheet.appendRow(["Thời gian ghi", "Ngày GD", "Người Gửi", "Tổng Tiền", "Số Món", "Chi Tiết Cược", "Trạng Thái"]);
    sheet.getRange(1, 1, 1, 7).setFontWeight("bold").setBackground("#e2e8f0");
  }
  
  var betDetails = data.bets.map(function(b) {
    return b.code + "-" + b.common_name + " (" + b.amount_k + "k)";
  }).join(", ");
  
  var status = data.is_valid ? "Hợp lệ" : "Lệch tiền (" + data.diff + ")";
  
  sheet.appendRow([
    dateStr,
    data.transaction_date, 
    data.sender_name, 
    data.total_amount, 
    data.bets.length, 
    betDetails, 
    status
  ]);
  
  return ContentService.createTextOutput(JSON.stringify({"status": "success"})).setMimeType(ContentService.MimeType.JSON);
}</pre>
                            <button @click="copyScript"
                                class="absolute top-2 right-2 bg-brand-600 hover:bg-brand-500 text-white text-xs font-bold px-3 py-1.5 rounded-lg shadow-lg flex items-center gap-1">
                                <i class="fa-regular fa-copy"></i> Copy
                            </button>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="relative pl-8 border-l-2 border-slate-700">
                        <div
                            class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 border-2 border-slate-900 text-[10px] flex items-center justify-center font-bold text-slate-300">
                            2</div>
                        <h4 class="text-sm font-bold text-brand-200 uppercase mb-2">Tạo Web App trên Google Sheets</h4>
                        <ul class="text-sm text-slate-400 space-y-2 list-disc pl-4">
                            <li>Mở Google Sheets của bạn -> Chọn <b>Extensions</b> -> <b>Apps Script</b>.</li>
                            <li>Xoá hết mã cũ và dán mã vừa copy vào.</li>
                            <li>Bấm <b>Deploy</b> -> <b>New deployment</b>.</li>
                            <li>Chọn type: <b>Web app</b>.</li>
                            <li>Mục <b>Who has access</b> chọn: <b>Anyone</b> (Quan trọng).</li>
                            <li>Bấm <b>Deploy</b> và copy <b>Web App URL</b>.</li>
                        </ul>
                    </div>

                    <!-- Step 3 -->
                    <div class="relative pl-8 border-l-2 border-slate-700">
                        <div
                            class="absolute -left-[9px] top-0 w-4 h-4 rounded-full bg-slate-700 border-2 border-slate-900 text-[10px] flex items-center justify-center font-bold text-slate-300">
                            3</div>
                        <h4 class="text-sm font-bold text-brand-200 uppercase mb-2">Dán URL vào đây</h4>
                        <input v-model="sheetDbUrl" type="text"
                            placeholder="https://script.google.com/macros/s/.../exec"
                            class="w-full bg-slate-950 text-white border border-slate-700 rounded-xl p-3 focus:border-brand-500 outline-none placeholder-slate-600 font-mono text-sm">
                    </div>
                </div>

                <div class="p-4 bg-slate-800/50 border-t border-white/5 flex justify-end gap-3">
                    <button @click="showSheetConfig = false"
                        class="px-4 py-2 rounded-lg text-slate-400 hover:text-white font-bold text-sm">Đóng</button>
                    <button @click="saveSheetConfig"
                        class="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded-lg text-sm font-bold shadow-lg shadow-brand-500/20">Lưu
                        Cấu Hình</button>
                </div>
            </div>
        </div>

        <!-- Error Modal -->
        <div v-if="errorMessage"
            class="fixed inset-0 z-[100] bg-black/80 backdrop-blur flex items-center justify-center p-4">
            <div
                class="bg-slate-900 border border-red-500/30 rounded-2xl max-w-md w-full p-6 shadow-2xl relative overflow-hidden">
                <div class="absolute top-0 left-0 w-1.5 h-full bg-red-500"></div>
                <h3 class="text-red-400 font-bold text-lg mb-2"><i class="fa-solid fa-circle-exclamation mr-2"></i> Đã
                    xảy ra lỗi</h3>
                <p class="text-slate-300 text-sm mb-6 leading-relaxed">{{ errorMessage }}</p>
                <div class="flex justify-end">
                    <button @click="errorMessage = ''"
                        class="px-5 py-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-white text-sm font-bold transition">Đóng</button>
                </div>
            </div>
        </div>

    </div>

    <!-- MAIN LOGIC -->
    <script>
        const { createApp } = Vue;

        const ANIMAL_DB = [
            { code: '01', alias: 'Chiếm Khôi', common: 'Cá Trắng' }, { code: '02', alias: 'Bản Quế', common: 'Con Ốc' },
            { code: '03', alias: 'Vinh Sanh', common: 'Con Ngỗng' }, { code: '04', alias: 'Phùng Xuân', common: 'Con Công' },
            { code: '05', alias: 'Chí Cao', common: 'Con Trùng' }, { code: '06', alias: 'Khôn Sơn', common: 'Con Cọp' },
            { code: '07', alias: 'Chánh Thuận', common: 'Con Heo' }, { code: '08', alias: 'Nguyệt Bửu', common: 'Con Thỏ' },
            { code: '09', alias: 'Hớn Vân', common: 'Con Trâu' }, { code: '10', alias: 'Giang Từ', common: 'Rồng Bay' },
            { code: '11', alias: 'Phước Tôn', common: 'Con Chó' }, { code: '12', alias: 'Quang Minh', common: 'Con Ngựa' },
            { code: '13', alias: 'Hữu Tài', common: 'Con Voi' }, { code: '14', alias: 'Chỉ Đắc', common: 'Con Mèo' },
            { code: '15', alias: 'Tất Khắc', common: 'Con Chuột' }, { code: '16', alias: 'Mậu Lâm', common: 'Con Ong' },
            { code: '17', alias: 'Trọng Tiên', common: 'Con Hạc' }, { code: '18', alias: 'Thiên Thân', common: 'Kỳ Lân' },
            { code: '19', alias: 'Cán Ngọc', common: 'Con Bướm' }, { code: '20', alias: 'Trân Châu', common: 'Hòn Đá' },
            { code: '21', alias: 'Thượng Chiêu', common: 'Con Én' }, { code: '22', alias: 'Song Đồng', common: 'Con Cu' },
            { code: '23', alias: 'Tam Hòe', common: 'Con Khỉ' }, { code: '24', alias: 'Hiệp Hải', common: 'Con Ếch' },
            { code: '25', alias: 'Cửu Quan', common: 'Con Quạ' }, { code: '26', alias: 'Thái Bình', common: 'Rồng Nằm' },
            { code: '27', alias: 'Hỏa Diệm', common: 'Con Rùa' }, { code: '28', alias: 'Nhựt Thăng', common: 'Con Gà' },
            { code: '29', alias: 'Địa Lương', common: 'Con Lươn' }, { code: '30', alias: 'Tỉnh Lợi', common: 'Cá Đỏ' },
            { code: '31', alias: 'Trường Thọ', common: 'Con Tôm' }, { code: '32', alias: 'Vạn Kim', common: 'Con Rắn' },
            { code: '33', alias: 'Thanh Tiền', common: 'Con Nhện' }, { code: '34', alias: 'Nguyên Kiết', common: 'Con Nai' },
            { code: '35', alias: 'Nhứt Phẩm', common: 'Con Dê' }, { code: '36', alias: 'An Sỹ', common: 'Con Yêu' }
        ];

        createApp({
            data() {
                return {
                    apiKey: localStorage.getItem('gemini_api_key') || '',
                    showKey: false,
                    imageSrc: null,
                    isProcessing: false,
                    errorMessage: '',
                    animalDb: ANIMAL_DB,

                    // Zoom/Pan State
                    zoomLevel: 100,
                    rotation: 0,
                    dragOver: false,

                    // Data Form
                    form: {
                        sender_name: '', transaction_date: '', total_amount: 0,
                        receiver_name: '', receiver_bank: '', receiver_account: '',
                        bets: []
                    },
                    availableModels: [
                        { id: 'gemini-1.5-flash', name: 'Gemini 1.5 Flash (Mặc định)' },
                        { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash (Mới)' }
                    ],
                    selectedModel: 'gemini-1.5-flash',
                    allowExportAnyway: false,
                    showSheetConfig: false,
                    sheetDbUrl: localStorage.getItem('sheet_db_url') || ''
                }
            },
            mounted() {
                if (this.apiKey) this.testConnection(true);
            },
            watch: {
                apiKey(newVal) { if (newVal) localStorage.setItem('gemini_api_key', newVal.trim()); }
            },
            computed: {
                sumBets() { return this.form.bets.reduce((acc, b) => acc + (b.amount_k || 0) * 1000, 0); },
                diff() { return (this.form.total_amount || 0) - this.sumBets; }
            },
            methods: {
                async testConnection(silent = false) {
                    if (!this.apiKey && !silent) return alert("Vui lòng nhập API Key trước!");
                    if (!this.apiKey && silent) return;
                    try {
                        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${this.apiKey.trim()}`);
                        const data = await res.json();

                        if (data.error) throw new Error(data.error.message);
                        if (!data.models) throw new Error("Không tìm thấy danh sách model.");

                        const validModels = data.models.filter(m => m.supportedGenerationMethods?.includes('generateContent'))
                            .map(m => m.name.replace('models/', ''));

                        // FORCE INJECT 1.5 Flash (Stability Fix)
                        if (!validModels.includes('gemini-1.5-flash')) {
                            // Ensure the stable model is always available
                            validModels.unshift('gemini-1.5-flash');
                        }

                        this.availableModels = validModels.map(id => ({ id: id, name: id.toUpperCase() }));
                        this.selectedModel = 'gemini-1.5-flash';

                        let msg = "Kết nối THÀNH CÔNG! ✅\n\nDanh sách Model đã được cập nhật tự động theo Key của bạn.\n\nHãy nhấn Đóng và thử lại.";
                        if (!silent) alert(msg);
                        console.log("Updated Available Models:", validModels);

                    } catch (e) {
                        if (!silent) alert("Kết nối THẤT BẠI ❌\nLỗi: " + e.message + "\n\nKiểm tra lại Internet hoặc API Key.");
                    }
                },
                // Image Handling
                async handleFileUpload(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    this.processFile(file);
                },
                handleDrop(e) {
                    this.dragOver = false;
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) this.processFile(file);
                },
                async processFile(file) {
                    this.errorMessage = '';
                    this.allowExportAnyway = false;

                    if (!this.apiKey || !this.apiKey.trim().startsWith('AIza')) {
                        this.errorMessage = "Vui lòng nhập Gemini API Key hợp lệ (bắt đầu bằng AIza) ở góc trên màn hình.";
                        return;
                    }

                    this.imageSrc = URL.createObjectURL(file);
                    this.resetZoom();
                    this.isProcessing = true;

                    try {
                        const base64Image = await this.fileToGenerativePart(file);
                        await this.analyzeImage(base64Image);
                    } catch (error) {
                        console.error(error);
                        this.errorMessage = `Lỗi hệ thống: ${error.message}`;
                    } finally {
                        this.isProcessing = false;
                    }
                },

                // AI Logic
                async analyzeImage(imagePart) {
                    const promptText = `
                    Bạn là một trợ lý AI chuyên xử lý biên lai cá cược. 
                    Nhiệm vụ: Trích xuất thông tin JSON CHÍNH XÁC TUYỆT ĐỐI từ ảnh.
                    
                    1. THÔNG TIN CHUNG: Tìm tên người gửi (In hoa), ngày giờ, tổng tiền chuyển khoản, người nhận.
                    2. DANH SÁCH CƯỢC:
                       - Tìm các dòng chứa tên con vật hoặc mã số (01-36).
                       - Map về format: { "code": "XX", "common_name": "Tên", "amount_k": Số_Tiền_Nghìn }
                       - Ví dụ: "Gà 50" -> code: 28, amount_k: 50. "28 50" -> code: 28, amount_k: 50.
                       - Lưu ý: 50k, 50.000, 50 -> đều là 50.
                    
                    DỮ LIỆU MAP CODE (Code - Tên):
                    ${JSON.stringify(this.animalDb.map(a => `${a.code}-${a.common}`))}

                    OUTPUT JSON ONLY (Không Markdown):
                    {
                        "sender_name": "NGUYEN VAN A", "transaction_date": "YYYY-MM-DDTHH:mm", "total_amount": 150000,
                        "receiver_name": "...", "receiver_bank": "...", "receiver_account": "...",
                        "bets": [ { "code": "01", "common_name": "Cá Trắng", "matched_text": "Cá trắng 10k", "amount_k": 10 } ]
                    }
                    `;

                    const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${this.apiKey.trim()}`;

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: promptText }, imagePart] }]
                            })
                        });

                        if (!response.ok) {
                            const errorBody = await response.text();
                            let errorMsg = `Lỗi ${response.status}: ${response.statusText}`;
                            try {
                                const errJson = JSON.parse(errorBody);
                                if (errJson.error && errJson.error.message) {
                                    errorMsg = `Google AI Error: ${errJson.error.message}`;
                                }
                            } catch (e) { }
                            throw new Error(errorMsg);
                        }

                        const data = await response.json();
                        if (!data.candidates || !data.candidates.length) {
                            if (data.promptFeedback && data.promptFeedback.blockReason) {
                                throw new Error(`AI từ chối xử lý: ${data.promptFeedback.blockReason}. Hãy thử ảnh khác.`);
                            }
                            throw new Error("AI không trả về kết quả (Phản hồi trống).");
                        }

                        let text = data.candidates[0].content.parts[0].text;
                        text = text.replace(/```json/g, '').replace(/```/g, '').trim();

                        let result;
                        try {
                            result = JSON.parse(text);
                        } catch (e) {
                            console.error("Non-JSON Response:", text);
                            throw new Error("AI trả về định dạng sai (Không phải JSON). Hãy thử lại.");
                        }

                        // Apply to Form
                        this.form = {
                            sender_name: result.sender_name || '',
                            transaction_date: result.transaction_date || new Date().toISOString().slice(0, 16),
                            total_amount: result.total_amount || 0,
                            receiver_name: result.receiver_name || '',
                            receiver_bank: result.receiver_bank || '',
                            receiver_account: result.receiver_account || '',
                            bets: result.bets || []
                        };
                    } catch (error) {
                        console.error("Full Error:", error);
                        // Specific check for file protocol which causes CORS/Fetch errors
                        if (window.location.protocol === 'file:') {
                            this.errorMessage = `LỖI GIAO THỨC FILE:// \n\nBạn đang mở file trực tiếp từ ổ cứng. Trình duyệt chặn kết nối API vì lý do bảo mật (CORS).\n\nCÁCH KHẮC PHỤC:\n1. Cài đặt Extension "Live Server" trong VS Code.\n2. Chuột phải vào file index.html -> chọn "Open with Live Server".\n3. Hoặc chạy lệnh Python: python -m http.server`;
                            return;
                        }

                        if (error.name === 'TypeError' && error.message.includes('fetch')) {
                            throw new Error("Lỗi kết nối mạng hoặc CORS. Kiểm tra lại Key hoặc mở bằng Live Server.");
                        }
                        if (error.message.includes('not found') || error.message.includes('404')) {
                            throw new Error("Lỗi Model không tìm thấy hoặc chưa được cấp quyền cho Key này. \n\nHãy thử chọn MODEL khác ở góc trên (ví dụ: Gemini 1.5 Pro hoặc Gemini 1.0 Pro).");
                        }
                        throw error;
                    }
                },

                // Utils
                fileToGenerativePart(file) {
                    return new Promise((resolve) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve({ inlineData: { data: reader.result.split(',')[1], mimeType: file.type } });
                        reader.readAsDataURL(file);
                    });
                },
                formatCurrency(val) { return val ? val.toLocaleString('vi-VN') : '0'; },
                updateTotalAmount(e) {
                    const clean = e.target.value.replace(/[^0-9]/g, '');
                    this.form.total_amount = clean ? parseInt(clean) : 0;
                },

                // Bets Management
                addBet(animal) {
                    this.form.bets.unshift({ code: animal.code, common_name: animal.common, matched_text: 'Thêm tay', amount_k: 0 });
                },
                removeBet(idx) { this.form.bets.splice(idx, 1); },

                // UI Controls
                resetApp() {
                    this.imageSrc = null; this.form = { sender_name: '', transaction_date: '', total_amount: 0, bets: [] };
                    this.errorMessage = '';
                },
                zoomIn() { if (this.zoomLevel < 300) this.zoomLevel += 25; },
                zoomOut() { if (this.zoomLevel > 50) this.zoomLevel -= 25; },
                resetZoom() { this.zoomLevel = 100; this.rotation = 0; },

                // Export
                copyScript() {
                    const code = document.getElementById('scriptCode').innerText;
                    navigator.clipboard.writeText(code).then(() => alert("Đã copy mã script!"));
                },
                saveSheetConfig() {
                    if (!this.sheetDbUrl) return alert("Vui lòng nhập URL Web App!");
                    localStorage.setItem('sheet_db_url', this.sheetDbUrl.trim());
                    this.showSheetConfig = false;
                    alert("Đã lưu cấu hình!");
                },
                async exportAction() {
                    if (this.sheetDbUrl) {
                        await this.exportToGoogleSheet();
                    } else {
                        if (confirm("Bạn chưa cấu hình Google Sheets. Tải về file CSV để lưu trữ?")) {
                            this.downloadExcel();
                        }
                    }
                },
                async exportToGoogleSheet() {
                    if (!this.sheetDbUrl) { this.showSheetConfig = true; return; }

                    const payload = {
                        transaction_date: this.form.transaction_date,
                        sender_name: this.form.sender_name,
                        total_amount: this.form.total_amount,
                        bets: this.form.bets,
                        is_valid: this.diff === 0,
                        diff: this.diff
                    };

                    try {
                        const btn = document.querySelector('button[title="Kết nối Google Sheets"]'); // visualization only

                        // Use no-cors mode for Google Apps Script Web App
                        await fetch(this.sheetDbUrl, {
                            method: 'POST',
                            mode: 'no-cors', // Opaque response
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });

                        // Since no-cors doesn't give status, we assume success if no network error.
                        // Ideally we'd use CORS but GAS requires redirect logic which is complex in pure client-side without proxy.
                        alert("Đã gửi yêu cầu lưu dữ liệu! (Hãy kiểm tra Google Sheet)");

                    } catch (e) {
                        alert("Lỗi gửi dữ liệu: " + e.message);
                    }
                },
                downloadExcel() {
                    let csvContent = "\uFEFFNgày,Người Gửi,Tổng Tiền,Mã,Con Vật,Cược (k),Thành Tiền\n";
                    const dateStr = this.form.transaction_date.replace('T', ' ');
                    this.form.bets.forEach(b => {
                        const row = [
                            `"${dateStr}"`, `"${this.form.sender_name}"`, this.form.total_amount,
                            `'${b.code}`, `"${b.common_name}"`, b.amount_k, b.amount_k * 1000
                        ];
                        csvContent += row.join(",") + "\n";
                    });

                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.href = url;
                    link.download = `V8_DoiSoat_${this.form.sender_name || 'Receipt'}.csv`;
                    link.click();
                }
            }
        }).mount('#app');
    </script>
</body>

</html>